let score=0,answered=!1,DATA=[],KEY='',SCORE_KEY='',DATA_HASH='';const isMobile=/Mobi|Android/i.test(navigator.userAgent)||window.matchMedia('(max-width: 768px)').matches;function initQuiz(data,key){DATA=data;KEY=key;SCORE_KEY=key+':score';DATA_HASH=JSON.stringify(DATA).length+'-'+DATA.length;const lastHash=localStorage.getItem(KEY+':hash');if(lastHash&&lastHash!==DATA_HASH){localStorage.removeItem(KEY);localStorage.removeItem(SCORE_KEY);localStorage.setItem(KEY+':hash',DATA_HASH);score=0;setIndex(0);location.reload();return}localStorage.setItem(KEY+':hash',DATA_HASH);const savedScore=parseInt(localStorage.getItem(SCORE_KEY)||'0',10);score=isNaN(savedScore)?0:savedScore;render()}function getIndex(){const v=parseInt(localStorage.getItem(KEY)||'0',10);return isNaN(v)?0:Math.max(0,Math.min(v,DATA.length-1))}function setIndex(i){localStorage.setItem(KEY,String(i))}function setScore(s){localStorage.setItem(SCORE_KEY,String(s))}function setBar(i){const pct=(i+1)/DATA.length*100;document.getElementById('bar').style.width=pct+'%'}function render(){const i=getIndex(),q=DATA[i];document.querySelector('.quiz-body').style.display='block';document.querySelector('.result').style.display='none';document.getElementById('progress').textContent=`Question ${i+1} of ${DATA.length}`;setBar(i);document.getElementById('qtext').textContent=q.q;const list=document.getElementById('choices');list.innerHTML='';q.options.forEach((t,idx)=>{const btn=document.createElement('button');btn.className='choice';btn.innerHTML=`<strong>${String.fromCharCode(65+idx)}.</strong> ${t}`;btn.addEventListener('click',()=>select(idx,q.correct,q.expl));list.appendChild(btn)});const ex=document.getElementById('ex');ex.style.display='none';ex.textContent='';answered=!1;document.querySelector('.btn-next').disabled=!0}function select(idx,correct,expl){if(answered)return;answered=!0;const nodes=document.querySelectorAll('.choice');nodes.forEach((n,i)=>{if(i===correct)n.classList.add('correct');if(i===idx&&idx!==correct)n.classList.add('incorrect')});if(idx===correct){score++;setScore(score)}const ex=document.getElementById('ex');ex.textContent='Explanation: '+(expl||'See handbook guidance for details.');ex.style.display='block';document.querySelector('.btn-next').disabled=!1}function next(){let i=getIndex();if(i<DATA.length-1){i+=1;setIndex(i);if(isMobile){location.reload()}else{render()}}else{document.querySelector('.quiz-body').style.display='none';document.querySelector('.result').style.display='block';document.getElementById('final-score').textContent=`You scored ${score} out of ${DATA.length}`}}function reset(){setIndex(0);score=0;localStorage.removeItem(SCORE_KEY);if(isMobile)location.reload();else render()}
